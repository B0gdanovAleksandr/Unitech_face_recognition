# Unitech_begginers
Создание прототипа ИИ-системы по распознаванию лиц для терминалов РЕВИЗОР
---

## Установка

- Скачайте или обновите локальную версию репозитария
```bash
git clone https://github.com/NeuronsUII/Unitech_begginers.git
```

- Перейдите в каталог репозитария
```bash
cd Unitech_begginers/recognizer
```

- Если запуск будет выполнятся из текущего каталога, то в linux для настройки выполните
```bash
source setup.sh
```

- Если требуется установить в отдельный каталог, то в linux выполните
- Если `<Каталог для установки>` не задан, то приложение будет установлено в `$HOME/.local/recognizer`
```bash
source install.sh <Каталог для установки>
```
---

## Запуск

- Для запуска в linux выполните
```bash
source run.sh
```
---

## Структура проекта

Проект состоит из следующих файлов и папок:

- [install.sh](install.sh): Копирует необходимые файлы в заданый каталог и устанавливает всё необходимое для запуска

- [setup.sh](setup.sh): Устанавливает виртуальную среду в Linux и все необходимые модули из [dotnet_requirements.txt](dotnet_requirements.txt)

- [dotnet_requirements.txt](dotnet_requirements.txt): Содержит информацию о необходимых для проекта python модулях 

- [run.sh](run.sh): Запускает виртуальную среду в Linux и код консольного приложения

- [recognizer.py](recognizer.py): Тестовый код для работы консольного приложения

- [dotnet](dotnet/): Каталог содержит файлы консольного `.NET` приложения
  - [Program.cs](dotnet/Program.cs): Главный файл консольного `.NET` приложения

- [unitech](unitech/): Каталог содержит основные python файлы проекта
  - [detector.py](unitech/detector.py): Содержит базовый класс, в котором реализованы методы управления БД, методы поиска эмбеддингов и методы запуска сканирования пользователей
  - [detector_Pluzhnikov.py](unitech/detector_Pluzhnikov.py): Содержит класс, в котором реализованы методы выбора и детекции лица и получение эмбеддингов лиц
  - [streams.py](unitech/streams.py): Состоит из нескольких python генераторов, которые формируют поток кадров из разных источников
  - [Reznik.py](unitech/Reznik.py): Внутри класс добавляющий функционал определения живости лица
  - [AntiSpoof/FaceAntiSpoofing.py](unitech/AntiSpoof/FaceAntiSpoofing.py): 
  - [saved_models/AntiSpoofing_bin_1.5_128.onnx](unitech/saved_models/AntiSpoofing_bin_1.5_128.onnx): 
 
- [tools](tools/): Каталог содержит вспомогательные python файлы проекта
  - [view.py](tools/view.py): В файле код для вывода изображения на экран
---

## Описание классов и методов

### Класс [`AntiSpoofSystem`](unitech/Reznik.py)

Класс `AntiSpoofSystem` наследуется от класса [`Recognizer`](unitech/detector_Pluzhnikov.py).
Класс `AntiSpoofSystem` добавляет функционал определения живости лица.

#### Методы класса:

- `__init__(self, spoof_model_path)`  
  Конструктор класса, наследует параметры инициализации от `Recognizer`, а также добавляет инициализацию модели для работы с эмбеддингами лиц.
  - `spoof_model_path` — путь к файлу, содержащему веса модели.

- `useAlivePerson(self, spoof_threshold=0.6, frames_threshold=0.9, frame_count=10)`
  Инициализирует порог определения живости или выключает определение живости при `threshold=0`.
  - `spoof_threshold` — порог определения живости
  - `frames_threshold` — пороговое отношение живых кадров к `frame_count`
  - `frame_count` — количество кадров взятых для анализа

- `frame_stream(self)`
  К базовой функции добавляет функционал сброса накопленных кадров.

- `selectFace(self, image)`
  К базовой функции добавляет функционал определения живости лица.
  - `image` — изображение в формате RGB, на котором находятся лица.

- `setAlivePerson(self)`
  Принимает решение настоящее лицо или нет.

- `checkAlivePerson(self, frame, bbox: tuple)`
  Анализ каждого кадра на живость лица.
  - `frame` — изображение в формате RGB, на котором находятся лица.
  - `frame` — координаты прямоугольника в котором проводится проверка живости лица.
    

### Класс [`Recognizer`](unitech/detector_Pluzhnikov.py)

Класс `Recognizer` наследуется от класса [`Algorithms`](unitech/detector_Pluzhnikov.py).
`Recognizer` добавляет функционал для распознавания лиц, работы с эмбеддингами и управления базой данных лиц.

#### Методы класса:

- `scaningNewUser(self, rgb)`  
  Сканирует новое лицо (нового пользователя) на изображении. Этот метод извлекает эмбеддинг лица, который позже может быть сохранен в базе данных для дальнейшего распознавания.
  - `rgb` — изображение в формате RGB, на котором сканируется лицо.

- `recognizingUser(self, rgb, metadata)`  
  Выполняет сравнение эмбеддинга лица с уже существующими эмбеддингами в базе данных. Возвращает результат распознавания и информацию о том, найден ли пользователь.
  - `rgb` — изображение для распознавания.
  - `metadata` — дополнительные данные, которые могут быть использованы для ускорения или улучшения распознавания.


### Класс [`FaceDetector`](unitech/detector_Pluzhnikov.py)

Класс `FaceDetector` является базовым классом для детекции лиц на изображениях. Он использует загруженные модели для нахождения координат лиц на изображении и их дальнейшей обработки.

#### Методы класса:

- `selectFace(self, rgb)`  
  Выбирает одно лицо из всех найденных на изображении. Использует внутренние алгоритмы для выбора наилучшего кандидата.
  - `rgb` — изображение в формате RGB, на котором находятся лица.


### Класс [`Algorithms`](unitech/detector_Pluzhnikov.py)

Класс `Algorithms` наследуется от класса [`DetectorBase`](unitech/detector.py).
Класс `Algorithms` расширяет функционал для обработки изображений и работы с лицами. Он реализует различные алгоритмы, такие как предсказание глубины с использованием MiDaS и выбор лица на основе площади, положения или глубины.

#### Методы класса:

- `useDepth(self, w_face_depth)`  
  Включает алгоритм, использующий предсказание глубины при выборе лица. Загружает предобученную модель MiDaS для глубины.
  - `w_face_depth` — вес для использования глубины при выборе лица. Чем больше вес, тем больше учитывается глубина лица.

- `useFacePosition(self, weight_central, weight_lower)`  
  Включает алгоритм, который учитывает положение лица на изображении. Чем ближе лицо к центральной линии и нижней части изображения, тем выше его приоритет.
  - `weight_central` — вес, отвечающий за влияние расстояния до центральной линии изображения.
  - `weight_lower` — вес, учитывающий расстояние от лица до нижней части изображения.

- `useFaceArea(self, w_face_area)`  
  Активирует алгоритм выбора лица на основе его площади. Лица с большей площадью получают больший приоритет.
  - `w_face_area` — вес площади лица. Чем больше вес, тем больший приоритет отдается лицам с большей площадью.

- `predict_depth(self, image)`  
  Выполняет предсказание глубины для изображения с использованием модели MiDaS. Возвращает карту глубины (тензор), где каждый пиксель отражает расстояние до камеры.
  - `image` — изображение, для которого требуется предсказать глубину.

- `cropFrame(self, frame)`  
  Обрезает изображение (кадр) до заданного размера, если это необходимо для обработки.
  - `frame` — исходное изображение для обрезки.

- `selectFace(self, image)`  
  Выполняет выбор лица на изображении, комбинируя результаты всех активированных алгоритмов (позиция, площадь, глубина). Этот метод возвращает координаты выбранного лица.
  - `image` — изображение, на котором производится выбор лица.

- `calculate_method1_scores(self, width, height, weight_central, weight_lower)`
  Рассчитывает баллы по центральной линии и нижней части
  - `width` — ширина изображения в пикселах.
  - `height` — высота изображения в пикселах.
  - `weight_central` — вес, отвечающий за влияние расстояния до центральной линии изображения.
  - `weight_lower` — вес, учитывающий расстояние от лица до нижней части изображения.

- `calculate_method2_scores(self, w_face_area)`
  Функция для расчета баллов по максимальной площади
  - `w_face_area` — вес площади лица. Чем больше вес, тем больший приоритет отдается лицам с большей площадью.

- `calculate_method3_scores(self, depth_map, w_face_depth)`
  Функция для расчета баллов по глубине
  - `depth_map` — изображение, где каждый пиксель соответствует глубине объекта.
  - `w_face_depth` — вес для использования глубины при выборе лица. Чем больше вес, тем больше учитывается глубина лица.


### Класс [`DetectorBase`](unitech/detector.py)

Базовый класс для создания детекторов лиц. Используется для определения общего интерфейса для добавления пользователей и получения пользователей из кадров изображений.

#### Методы класса:

- `beginScan(self)`
  Регистрирует пользователя в базе данных. Выдает ID пользователя типа GUID

- `faceRecognitionAll(self)`
  Запускает распознавание пользователя и поиск в базе данных. Выдает ID пользователя типа GUID

- `scanNewUser(self)`
  Расчитывает эмбеддинги лица, извлеченные из изображения.

- `recognizeUser(self)`
  Выдает идентификатор пользователя, если лицо найдено, иначе None.

- `setAdressCamera(self, video_path=0, frame_step=1)`
  Инициализация источника видеопотока с использованием адреса камеры.
  - `video_path` — адрес камеры для захвата (индекс устройства или URL).
  - `frame_step` — задает шаг, с которым кадры извлекаются из видеопотока.

- `getVideo(self)`
  Возвращает кадр видеопотока, который обрабатывается в данный момент

- `exportFromData(self, guid)`
  Выдает список эмбеддингов для запрошенного GUID
  - `guid` — ID пользователя типа GUID

- `importToData(self, guid, embeddings)`
  Занесение эмбеддингов в базу sqllite
  - `guid` — ID пользователя типа GUID 
  - `embeddings` — Набор векторов

- `deleteDataById(self, guid)`
  Удаление из базы данных SQL пользователей по ID
  - `guid` — ID пользователя типа GUID 

- `deleteAllFromData(self)`
  Удаление всех пользователей из базы данных SQL

- `useThreading(self, enable)`
  Включение режима многопоточности
  - `enable` — выбор режима булевого типа

- `setDB(self, db_path)`
  Загружает данные пользователя из базы sqllite
  - `db_path` — путь к файлу базы sqllite

- `streamFromOneFile(self, video_path)`
  Инициализация источника видеопотока всего из одного кадра
  - `video_path` — путь к файлу, содержащему один кадр изображения потенциального пользователя

- `streamFromDirectory(self, video_path, file_mask)`
  Инициализация источника видеопотока из кадров собранных из файлов изображений
  - `video_path` — путь к каталогу, содержащему файлы кадров изображений потенциального пользователя 
  - `file_mask` — маска типа файла в формате '*.*' для фильтрации файлов изображений

- `frame_stream(self)`
  Генерирует поток кадров для обработки, в соответствии заданному источнику видеопотока

- `createDB(self)`
  Создает пустую таблицу в sqllite базе для хранения GUID и эмбеддингов

- `loadDBtoDataFrame(self)`
  Выгружает все GUID и эмбеддинги из sqllite базы в pandas DataFrame

- `addEmbeddingsToDataFrame(self, guid, embeddings)`
  Добавляет в pandas DataFrame один GUID и соответствующие ему эмбеддинги
  - `guid` — ID пользователя типа GUID 
  - `embeddings` — Список эмбеддингов

- `executeInThread(self, function)`
  Выполняет функцию или в отдельном потоке или в текущем в зависимости от настроек
  - `function` — Ссылка на выполняемую функцию

- `beginScanThread(self, result_queue)`
  Регистрирует пользователя в базе данных. Выдает ID пользователя типа GUID, используя `Queue`.
  - `result_queue` — экземпляр объекта `Queue`

- `faceRecognitionAllThread(self, result_queue)`
  Запускает распознавание пользователя и поиск в базе данных. Выдает ID пользователя типа GUID, используя `Queue`.
  - `result_queue` — экземпляр объекта `Queue`

- `searchGuidInDataframe(self, embedding)`
  Выполняет поиск GUID в базе, который наиболее близок вектору `embedding`
  - `embedding` — Вектор эмбеддинг, полученный при распознавании пользователя

- `searchGuidByMin(self, embedding )`
  В базе пользователей ищет GUID с вектором наиболее близким вектору `embedding`, используя метод перебора всех записей 
  - `embedding` — Вектор эмбеддинг, полученный при распознавании пользователя

- `useDistanceMetric(self, distance_metric, distance_threshold, distance_search_type='bruteforce')`
  Настраивает режим поиска ближайшего эмбеддинга из базы пользователей
  - `distance_metric` — Выбор метрики для расчета расстояния (доступно: ‘braycurtis’, ‘canberra’, ‘chebyshev’, ‘cityblock’, ‘correlation’, ‘cosine’, ‘dice’, ‘euclidean’, ‘hamming’, ‘jaccard’, ‘jensenshannon’, ‘kulczynski1’, ‘mahalanobis’, ‘matching’, ‘minkowski’, ‘rogerstanimoto’, ‘russellrao’, ‘seuclidean’, ‘sokalmichener’, ‘sokalsneath’, ‘sqeuclidean’, ‘yule’)
  - `distance_threshold` — Пороговое значение расстояние, больше которого ближайший эмбеддинг считается не найденным.
  - `distance_search_type` — метод поиска наиболее близкого вектора ('bruteforce' или 'KNN')

- `refitKNN(self)`
  Переобучает kNN модель используя имеющиеся векторы из базы

- `searchGuidByKnn(self, embedding)`
  В базе пользователей ищет GUID с вектором наиболее близким вектору `embedding`, используя метод kNN
  - `embedding` — Вектор эмбеддинг, полученный при распознавании пользователя


### Класс [`AntiSpoof`](unitech/AntiSpoof/FaceAntiSpoofing.py)

Класс инициирует модель определения живости и про. Используется для определения живости лиц и инициализации соответствующей модели.

#### Методы класса:

- `__init__(self, weights: str):
  Инициализация объекта класса AntiSpoof.
  - `weights` — путь к файлу, содержащему веса модели.

- `_init_session_(self, onnx_model_path: str)`
  Инициализация модели и получение объект для инференса модели.
  - `onnx_model_path` — путь к файлу, содержащему веса модели.

- `preprocessing(self, img)`
  Предобработка входного изображения в модель.
  - `img` — Изображение, которое обязательно в формате numpy массива и с цветовым пространством RGB.

- `postprocessing(self, prediction)`
   Постобработка предсказаний модели. Применяется ф-ция активации softmax для выходных значений классификатора. Возвращает список вероятностей принадлежности изображения к определенному классу (настоящий, не настоящий).
  - `prediction` — Выходные значения классификатора

- `__call__(self, imgs)`
  Возвращает False, в случае если модель не сработает или список предсказаний модели для каждого переданного изображения, где элемент с индексом [0][0] - вероятность, что на первом изображении настоящий человек.
  - `imgs` — Список изображений, если одно, то задаётся [img]


- `increased_crop(img, bbox, bbox_inc, marking)`
  Статический метод для получения обрезанного лица с увеличенной областью
   - `img` — Исходный кадр/изображение которое хотим проверить на живость  
   - `bbox` — Координаты ограничивающей рамки
   - `bbox_inc` — Коэффициент увеличения. Defaults to 1.5.
   - `marking` — Формат разметки, доступные 'coco', 'voc', 'yolo'. Defaults to 'yolo'.

- `__str__(self)`
  Показывает строковое описание экземпляра класса.
