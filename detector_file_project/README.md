
---

# README: Система Обнаружения и Распознавания Лиц

## Обзор

Добро пожаловать в Систему Обнаружения и Распознавания Лиц! Этот проект использует техники компьютерного зрения для идентификации и распознавания лиц на изображениях. Включает функции выбора целевых лиц на основе различных критериев, таких как центральное положение, площадь и информация о глубине.

### Ключевые Возможности

- **Обнаружение Лиц**: Определение лиц на изображении.
- **Выбор Лица**: Выбор лучшего кандидата для распознавания на основе заданных критериев.
- **Предсказание Глубины**: Оценка расстояния до обнаруженных лиц.

## Требования

Перед тем как начать, убедитесь, что у вас установлено следующее программное обеспечение:

- Python 3.x
- Необходимые библиотеки (см. ниже)

### Необходимые Библиотеки

Вы можете установить необходимые библиотеки с помощью pip. Откройте интерфейс командной строки и выполните следующую команду:

```bash
pip install insightface numpy Pillow opencv-python torch torchvision
```
---

## Описание классов и методов

### Класс `Algorithms`

Класс `Algorithms` расширяет функционал для обработки изображений и работы с лицами. Он реализует различные алгоритмы, такие как предсказание глубины с использованием MiDaS и выбор лица на основе площади, положения или глубины.

#### Методы класса:

- `__init__(self, config, post_processing, models)`  
  Конструктор класса. Инициализирует алгоритмы, загружает модели и применяет параметры из конфигурации. 
  - `config` — словарь с конфигурационными параметрами.
  - `post_processing` — флаг, указывающий, требуется ли постобработка изображения.
  - `models` — содержит информацию о загружаемых моделях, таких как модели для детекции лиц или предсказания глубины.

- `useDepth(self, w_face_depth)`  
  Включает алгоритм, использующий предсказание глубины при выборе лица. Загружает предобученную модель MiDaS для глубины.
  - `w_face_depth` — вес для использования глубины при выборе лица. Чем больше вес, тем больше учитывается глубина лица.

- `useFacePosition(self, weight_central, weight_lower)`  
  Включает алгоритм, который учитывает положение лица на изображении. Чем ближе лицо к центральной линии и нижней части изображения, тем выше его приоритет.
  - `weight_central` — вес, отвечающий за влияние расстояния до центральной линии изображения.
  - `weight_lower` — вес, учитывающий расстояние от лица до нижней части изображения.

- `useFaceArea(self, w_face_area)`  
  Активирует алгоритм выбора лица на основе его площади. Лица с большей площадью получают больший приоритет.
  - `w_face_area` — вес площади лица. Чем больше вес, тем больший приоритет даётся лицам с большей площадью.

- `predict_depth(self, image)`  
  Выполняет предсказание глубины для изображения с использованием модели MiDaS. Возвращает карту глубины (тензор), где каждый пиксель отражает расстояние до камеры.
  - `image` — изображение, для которого требуется предсказать глубину.

- `cropFrame(self, frame)`  
  Обрезает изображение (кадр) до заданного размера, если это необходимо для обработки.
  - `frame` — исходное изображение для обрезки.

- `selectFace(self, image)`  
  Выполняет выбор лица на изображении, комбинируя результаты всех активированных алгоритмов (позиция, площадь, глубина). Этот метод возвращает координаты выбранного лица.
  - `image` — изображение, на котором производится выбор лица.

### Класс `Recognizer`

Класс `Recognizer` наследует возможности от `Algorithms` и добавляет функционал для распознавания лиц, работы с эмбеддингами и управления базой данных лиц.

#### Методы класса:

- `__init__(self, config, post_processing, models)`  
  Конструктор класса, наследует параметры инициализации от `Algorithms`, а также добавляет инициализацию модели для работы с эмбеддингами лиц.
  - `config`, `post_processing`, `models` — передаются в базовый класс `Algorithms`.

- `scaningNewUser(self, rgb)`  
  Сканирует новое лицо (нового пользователя) на изображении. Этот метод извлекает эмбеддинг лица, который позже может быть сохранён в базе данных для дальнейшего распознавания.
  - `rgb` — изображение в формате RGB, на котором сканируется лицо.

- `recognizingUser(self, rgb, metadata)`  
  Выполняет сравнение эмбеддинга лица с уже существующими эмбеддингами в базе данных. Возвращает результат распознавания и информацию о том, найден ли пользователь.
  - `rgb` — изображение для распознавания.
  - `metadata` — дополнительные данные, которые могут быть использованы для ускорения или улучшения распознавания.

- `createEmbedding(self, face)`  
  Создаёт эмбеддинг лица, используя предобученную модель для извлечения признаков лица. Эмбеддинг — это числовое представление лица, которое можно использовать для его идентификации.
  - `face` — изображение лица, которое будет преобразовано в эмбеддинг.

- `saveEmbedding(self, user_id, embedding)`  
  Сохраняет эмбеддинг нового пользователя в базе данных для последующего распознавания.
  - `user_id` — уникальный идентификатор пользователя.
  - `embedding` — эмбеддинг, представляющий лицо пользователя.

### Класс `FaceDetector`

Класс `FaceDetector` является базовым классом для детекции лиц на изображениях. Он использует загруженные модели для нахождения координат лиц на изображении и их дальнейшей обработки.

#### Методы класса:

- `__init__(self, config)`  
  Инициализирует детектор лиц, загружая необходимые модели и параметры из конфигурации.
  - `config` — словарь с конфигурацией для детектора лиц.

- `detect(self, image)`  
  Выполняет детекцию лиц на переданном изображении. Возвращает список координат для каждого обнаруженного лица.
  - `image` — изображение, на котором происходит поиск лиц.

- `selectFace(self, rgb)`  
  Выбирает одно лицо из всех найденных на изображении. Использует внутренние алгоритмы для выбора наилучшего кандидата.
  - `rgb` — изображение в формате RGB, на котором находятся лица.

### Дополнительные классы и функции

- `DetectorBase`:  
  Базовый класс, от которого наследуются все детекторы. Обеспечивает базовую функциональность для обработки изображений и работы с детекцией.

- `load_model(self, model_name)`:  
  Загружает предобученную модель по её названию. Может использоваться для загрузки моделей детекции лиц, предсказания глубины и других.

---

## Начало Работы

1. **Клонирование Репозитория**: Если вы еще не сделали этого, клонируйте проект на свой локальный компьютер.

   ```bash
   git clone <URL-репозитория>
   cd <папка-репозитория>
   ```

2. **Запуск Основного Скрипта**: Откройте интерфейс командной строки, перейдите в папку, где расположен проект, и выполните следующую команду:

   ```bash
   python detector_final.py
   ```

## Настройка

Система позволяет вам настраивать различные параметры, чтобы повлиять на процессы обнаружения и распознавания лиц. Ниже приведены настраиваемые параметры и их описания.

### Регулировка Параметров

1. **Параметры Весов**:
   - `useFacePosition(weight_central, weight_lower)`: Управляет влиянием центрального положения лица и его нижней части в процессе выбора.
     - `weight_central`: Влияние центрального положения (от 0 до 1).
     - `weight_lower`: Влияние нижней части (от 0 до 1).
     
   Пример:
   ```python
   useFacePosition(0.4, 0.2)  # 40% для центрального положения, 20% для нижней части
   ```

2. **Площадь Лица**:
   - `useFaceArea(w_face_area)`: Определяет влияние площади лица в процессе выбора.
     - `w_face_area`: Влияние веса (от 0 до 1).

   Пример:
   ```python
   useFaceArea(4)  # Высокое влияние на площадь лица
   ```

3. **Информация о Глубине**:
   - `useDepth(w_face_depth)`: Управляет тем, учитывается ли информация о глубине для выбора лица.
     - `w_face_depth`: Включить (1) или отключить (0) использование глубины.

   Пример:
   ```python
   useDepth(1)  # Использовать информацию о глубине
   ```

4. **Обрезка**:
   - `useCropping(enable)`: Включить или отключить обрезку изображения перед обработкой.
     - `enable`: Установите в `True`, чтобы включить обрезку, `False`, чтобы отключить.

   Пример:
   ```python
   useCropping(True)  # Включить обрезку
   ```

## Как Использовать Систему

1. **Сканирование Нового Пользователя**:
   Чтобы просканировать нового пользователя, вызовите метод `scaningNewUser(rgb)`, где `rgb` — это RGB-изображение, содержащее лицо.

   ```python
   result = scaningNewUser(image)
   ```

2. **Распознавание Пользователя**:
   Чтобы распознать пользователя, вызовите метод `recognizingUser(rgb, metadata)` с RGB-изображением и любой соответствующей метаинформацией.

   ```python
   recognized_user = recognizingUser(image, metadata)
   ```

## Пример Использования

Вот простой пример того, как использовать систему в Python-скрипте:

```python
from your_module import FaceDetector

# Инициализация детектора лиц
detector = FaceDetector()

# Установка параметров
detector.useFacePosition(0.5, 0.5)
detector.useFaceArea(1)
detector.useDepth(1)
detector.useCropping(True)

# Загрузка изображения
image = cv2.imread("путь_к_изображению.jpg")

# Сканирование нового пользователя
detector.scaningNewUser(image)

# Распознавание пользователя
recognized_user = detector.recognizingUser(image, metadata)
if recognized_user:
    print("Пользователь распознан:", recognized_user)
else:
    print("Пользователь не распознан.")
```

## Устранение Неисправностей

- **Не Обнаружены Лица**: Убедитесь, что изображение четкое и содержит лица.
- **Проблемы с Установкой**: Убедитесь, что все необходимые библиотеки установлены правильно.

## Заключение

Эта Система Обнаружения и Распознавания Лиц предоставляет простой интерфейс для обнаружения и распознавания лиц на изображениях. Пользователи могут регулировать параметры, чтобы точно настроить поведение системы в соответствии с их конкретными потребностями.

Возможности применения
Система может быть интегрирована в различные области, включая:

Безопасность и контроль доступа: Использование для идентификации пользователей и контроля доступа в здания или защищённые зоны.

Объектный анализ в розничной торговле: Определение и анализ клиентских лиц для улучшения обслуживания и персонализации предложений.

Социальные сети: Автоматическое распознавание пользователей на фотографиях и видео, упрощение процесса тегирования и поиска.

Умные дома: Интеграция в системы умного дома для идентификации жильцов и гостей, обеспечивая автоматизацию действий на основе распознавания лиц.

Медицинская диагностика: Использование в медицине для мониторинга пациентов, выявления эмоциональных состояний и диагностики различных заболеваний.

Образование: Внедрение в образовательные учреждения для автоматизации процессов регистрации и мониторинга присутствия.

Развлечения: Использование в игровых приложениях для создания персонализированного опыта на основе распознавания лиц.

Таким образом, система обладает широкими возможностями применения и может стать частью более сложных решений в различных отраслях, улучшая эффективность и качество обслуживания пользователей.